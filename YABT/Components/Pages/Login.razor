@page "/login"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Microsoft.AspNetCore.Identity
@using YABT.Models
@using YABT.Services
@inject YABT.IServices.IUserService UserService
@inject ProtectedLocalStorage LocalStorage
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ToastService ToastService

<PageTitle>Login</PageTitle>

<div class="container vh-100 d-flex align-items-center justify-content-center">
    <div class="card shadow-sm p-4" style="width: 100%; max-width: 400px;">
        <h3 class="text-center mb-4">Sign in</h3>

        <EditForm Model="User" OnValidSubmit="TryLogin">
            <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" @bind="User.Email" class="form-control" placeholder="you@example.com" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Password</label>
                <div class="input-group">
                    <InputText class="form-control" type="@passwordType" @bind-Value="password" required/>
                    <button type="button" class="btn btn-outline-secondary" @onclick="TogglePassword" aria-label="Toggle password visibility">
                        <i class="bi @(passwordType == "password" ? "bi-eye" : "bi-eye-slash")"></i>
                    </button>
                </div>
            </div>

            <button type="submit" class="btn btn-primary w-100 py-2 fw-semibold">Login</button>
        </EditForm>

        <div class="text-center mt-3">
            <small>
                Don’t have an account?
                <a href="/register">Register</a>
            </small>
        </div>
        <div class="text-center mt-3">
            <button class="btn btn-outline-secondary" @onclick="ToggleTheme">Toggle Dark Mode</button>
        </div>
    </div>
</div>


@code {
    User User = new User();

    private async Task TryLogin()
    {
        if (UserExists(User.Email))
        {
            User storedUser = UserService.GetUserByEmail(User.Email);
            var hasher = new PasswordHasher<User>();
            var result = hasher.VerifyHashedPassword(storedUser, storedUser.PasswordHash, password);
            if (result == PasswordVerificationResult.Success)
            {
                storedUser.LastActivityDate = DateTime.UtcNow;
                UserService.AddOrUpdateOne(storedUser);
                
                await LocalStorage.SetAsync("YABTUserId", storedUser.Id);
                await LocalStorage.SetAsync("Email", storedUser.Email);
                await LocalStorage.SetAsync("Username", storedUser.Username);
                Navigation.NavigateTo("/library");
            }
            else
            {
                ToastService.ShowToast("Wrong email or password!");
            }
        }
        else
        {
            ToastService.ShowToast("User with this email doesn't exist!<br><span><a href=\"/register\">Register</a> a new account?</span>");
        }
    }

    private void NavigateToRegister()
    {
        Navigation.NavigateTo("/register");
    }
    
    private bool UserExists(string email)
    {
        return UserService.GetUserByEmail(email) != null;
    }
    
    private string passwordType = "password";
    private string password = string.Empty;

    void TogglePassword()
    {
        passwordType = passwordType == "password" ? "text" : "password";
    }
    
    //toggle dark or light mode
    private async Task ToggleTheme()
    {
        await JS.InvokeVoidAsync("toggleTheme");
    }
}