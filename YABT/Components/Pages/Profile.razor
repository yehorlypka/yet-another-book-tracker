@page "/profile"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Microsoft.AspNetCore.Identity
@using YABT.Components.Layout
@using YABT.Models
@using YABT.Services
@inject YABT.IServices.IUserService UserService
@inject ToastService ToastService
@inject ProtectedLocalStorage LocalStorage
@inject NavigationManager Navigation
@layout AuthenticatedLayout

<PageTitle>Profile</PageTitle>

<div class="container vh-100 d-flex flex-column align-items-center justify-content-center">
    <div class="card shadow-sm p-4" style="width: 100%; max-width: 450px;">
        <h3 class="text-center mb-4">Your Profile</h3>

        @if (User != null)
        {
            <div class="mb-3">
                <label class="form-label">Email (login)</label>
                <input type="email" class="form-control" value="@User.Email" disabled />
            </div>

            <EditForm Model="User" OnValidSubmit="UpdateProfile">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" @bind="User.Username" class="form-control" required />
                </div>

                <div class="mb-3">
                    <label class="form-label">New Password</label>
                    <div class="input-group">
                        <InputText class="form-control" type="@passwordType" @bind-Value="newPassword" />
                        <button type="button" class="btn btn-outline-secondary" @onclick="TogglePassword" aria-label="Toggle password visibility">
                            <i class="bi @(passwordType == "password" ? "bi-eye" : "bi-eye-slash")"></i>
                        </button>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Registered on</label>
                    <input type="text" class="form-control" value="@User.RegistrationDate?.ToShortDateString()" disabled />
                </div>

                <button type="submit" class="btn btn-primary w-100 py-2 fw-semibold">Update Profile</button>
            </EditForm>
        }
        else
        {
            <p>Loading user data...</p>
        }
    </div>
</div>

@code {
    private User? User;
    private string newPassword = string.Empty;
    private string passwordType = "password";

    protected override async Task OnInitializedAsync()
    {
        var result = await LocalStorage.GetAsync<string>("YABTUserId");
        string userId = result.Value ?? "";
        User = UserService.GetOne(userId);
    }

    private void TogglePassword()
    {
        passwordType = passwordType == "password" ? "text" : "password";
    }

    private async Task UpdateProfile()
    {
        if (User != null)
        {
            if(string.IsNullOrEmpty(newPassword))
                ToastService.ShowToast("Password cannot be empty!");
            else
            {
                var hasher = new PasswordHasher<User>();
                User.PasswordHash = hasher.HashPassword(User, newPassword);
            }

            UserService.AddOrUpdateOne(User);

            // Update LocalStorage in case username changed
            await LocalStorage.SetAsync("Username", User.Username);

            ToastService.ShowToast("Profile updated successfully!");
            newPassword = string.Empty;
            passwordType = "password";
        }
    }
}