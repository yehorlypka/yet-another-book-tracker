@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using YABT.Models
@inherits LayoutComponentBase
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject YABT.IServices.IUserService UserService
@inject ProtectedLocalStorage LocalStorage

<div class="app-header d-flex justify-content-between align-items-center px-3 py-2 shadow-sm"
     style="background-color: var(--bs-body-bg); border-bottom: 1px solid var(--bs-border-color); position: sticky; top: 0; z-index: 1020;">
    
    <!-- Left links: Profile + Library -->
    <div class="d-flex align-items-center gap-3">
        <a href="/profile" class="text-decoration-none" style="color: var(--bs-body-color);">
            <i class="bi bi-person-circle"></i> My Profile
        </a>
        <span class="divider mx-2"></span>
        <a href="/library" class="text-decoration-none" style="color: var(--bs-body-color);">
            <i class="bi bi-book"></i> Library
        </a>
        <span class="divider mx-2"></span>
        <a href="/search" class="text-decoration-none" style="color: var(--bs-body-color);">
            <i class="bi bi-search"></i> Add Books
        </a>
    </div>

    <!-- Right buttons: Theme + Logout -->
    <div class="d-flex align-items-center gap-2">
        <button class="btn btn-outline-info btn-sm" @onclick="ToggleTheme">
            <i class="bi @(theme == "dark" ? "bi-sun" : "bi-moon")"></i>
            @((theme == "dark" ? "Light Mode" : "Dark Mode"))
        </button>
        <span class="divider mx-2"></span>
        <button class="btn btn-outline-danger btn-sm" @onclick="Logout">
            <i class="bi bi-box-arrow-right"></i> Log Out
        </button>
    </div>
</div>

<div class="app-body p-3">
    @Body
    <Toast />
</div>

@code {
    private async Task Logout()
    {
        // update last activity date
        var result = await LocalStorage.GetAsync<string>("YABTUserId");
        var userId = result.Value;
        User user = UserService.GetOne(userId);
        user.LastActivityDate = DateTime.UtcNow;
        UserService.AddOrUpdateOne(user);

        // remove user data from localStorage 
        await LocalStorage.DeleteAsync("YABTUserId");
        await LocalStorage.DeleteAsync("Email");
        await LocalStorage.DeleteAsync("Username");
        // redirect to login
        Navigation.NavigateTo("/login", forceLoad: true);
    }
    
    // private bool isDarkMode = false;
    private string theme = "dark";
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        theme = await JS.InvokeAsync<string>("getTheme");
        StateHasChanged();
    }

    //toggle dark or light mode
    private async Task ToggleTheme()
    {
        await JS.InvokeVoidAsync("toggleTheme");
        theme = await JS.InvokeAsync<string>("getTheme");
    }
}